<?xml version="1.0" encoding="UTF-8"?>
<d:document xmlns="http://www.w3.org/1999/xhtml"
		  xmlns:d="http://cssbox.sourceforge.net/docs">
<d:title>CSSBox Manual</d:title>
<d:author>Radek Burget<br/>
<a href="mailto:burgetr@fit.vutbr.cz">burgetr@fit.vutbr.cz</a>
</d:author>

<d:toc />

<d:section id="intro">
<d:title>Introduction</d:title>
<p>CSSBox is an (X)HTML/CSS rendering engine written in pure Java. Its 
primary purpose is to provide a complete and further processable information 
about the rendered page contents and layout.</p>
<p>This manual gives a short overview of the CSSBox usage. It shows how to
render a document and it explains how the resulting page is represented and
how the basic information about the individual parts can be obtained.</p>
<p>More detailed information about the individual classes can be obtained
from the <d:api>API documentation</d:api>.</p>
<p>Any feedback to CSSBox and/or this manual is welcome via the
<a href="http://cssbox.sourceforge.net/">CSSBox website</a>.</p>
</d:section>

<d:section title="Basic usage" id="basic">
<d:title>Basic usage</d:title>
<p>The input of the rendering engine is a document DOM tree. The engine is able to
automatically load the style sheets referenced in the document and it computes the
efficient style of each element. Afterwrads, the document layout is computed.</p>

<d:subsection id="basicLoading">
<d:title>Document Loading</d:title>
<p>In the examples, the <a href="http://jtidy.sourceforge.net/">JTidy</a> HTML parser
is used. However, any other DOM parser can be used. For creating the DOM tree using
JTidy, following code can be used:</p> 

<d:codebox>
<em>//Open the network connection</em> 
URL url = new URL("http://cssbox.sf.net");
URLConnection con = url.openConnection();
InputStream is = con.getInputStream();

<em>//Parse the input document using jTidy</em>
Tidy tidy = new Tidy();
tidy.setTrimEmptyElements(false);
tidy.setInputEncoding("utf-8");
Document doc = tidy.parseDOM(is, null);
</d:codebox>>

<p>Note that JTidy has many configuration options that can be found in the
documentation.</p>
<p>For the initial DOM and style sheet processing, a
<d:api class="org/fit/cssbox/css/DOMAnalyzer">DOMAnalyzer</d:api> object is used. It is
initialized with the DOM tree and the base URL:</p>
<d:codebox>
DOMAnalyzer da = new DOMAnalyzer(doc, url);
da.attributesToStyles(); <em>//convert the HTML presentation attributes to inline styles</em>
da.addStyleSheet(null, CSSNorm.stdStyleSheet()); <em>//use the standard style sheet</em>
da.addStyleSheet(null, CSSNorm.userStyleSheet()); <em>//use the additional style sheet</em>
da.getStyleSheets(); <em>//load the author style sheets</em>
</d:codebox>
<p>The <d:api class="org/fit/cssbox/css/DOMAnalyzer" anchor="attributesToStyles()">attributesToStyles()</d:api>
method converts some HTML presentation attributes to CSS
styles (e.g. the <d:tag>font</d:tag> tag attributes, table attributes and some more). If (X)HTML
interpretation is not required, this method need not be called.</p> 
<p>The <d:api class="org/fit/cssbox/css/DOMAnalyzer" anchor="addStyleSheet(java.net.URL, java.lang.String)">addStyleSheet()</d:api> 
method is used to add a style sheet to the document. The style sheet is passed as a text
string containing the CSS code. In our case, we add two built-in style sheets that represent the standard document style.
The <d:api class="org/fit/cssbox/css/CSSNorm" anchor="stdStyleSheet()">CSSNorm.stdStyleSheet()</d:api>
method returns the default style sheet recommended by the CSS specification and the
<d:api class="org/fit/cssbox/css/CSSNorm" anchor="userStyleSheet()">CSSNorm.userStyleSheet()</d:api> 
contains some additional CSSBox definitions not covered by the standard.</p>
<p>Finally, the <d:api class="org/fit/cssbox/css/DOMAnalyzer" anchor="getStyleSheets()">getStyleSheets()</d:api>
method loads and processes all the internal and external style sheets referenced from the document including the inline
style definitions. In case of external style sheets, CSSBox tries to obtain
the file from the corresponding URL, if accessible.</p>
<p><em><strong>NOTE:</strong> Since the CSSBox 2.0 version, when the <code>attributesToStyles()</code> method is used
for interpreting the HTML presentation attributes, it must be called before <code>getStyleSheets()</code> is used.
Otherwise, the presentation attributes will not be considered in the resulting style.</em></p>
<p>The resulting <d:api class="org/fit/cssbox/css/DOMAnalyzer">DOMAnalyzer</d:api> object represents
the document code together with the associated style.</p>
</d:subsection>

<d:subsection id="basicLayout">
<d:title>Obtaining the Layout</d:title>
<p>The whole layout engine is represented by a graphical
<d:api class="org/fit/cssbox/layout/BrowserCanvas">BrowserCanvas</d:api> object. The layout is
computed automatically by creating an instance of this object. The constructor arguments are
the root DOM element (normally, it is the <d:tag>body</d:tag> element), the DOMAnalyzer used
for obtaining the element styles, the initial viewport dimensions and the document base URL used
for loading images and other referenced content.</p>
<d:codebox>
BrowserCanvas browser = 
        new BrowserCanvas(da.getBody(),
                          da,
                          new java.awt.Dimension(1000, 600),
                          url);
</d:codebox>
</d:subsection>
<p>The created <code>browser</code> object can be directly used for both displaying
the rendered document and for obtaining the created layout model.</p>

<d:subsection id="basicDisplay">
<d:title>Displaying the document</d:title>
<p>The <d:api class="org/fit/cssbox/layout/BrowserCanvas">BrowserCanvas</d:api> class is
directly derived from the Swing <code>javax.swing.JPanel</code> class. Therefore, it can
be directly used as a Swing user interface component. The size of the component is
automatically adjusted according to the resulting document layout. The basic document
displaying is shown in the <d:api class="org/fit/cssbox/demo/SimpleBrowser">SimpleBrowser</d:api>
example.</p>
</d:subsection>
</d:section> 

<d:section id="model">
<d:title>Rendered Document Model</d:title>
<p>The resulting document layout is represented as a tree of <dfn>boxes</dfn>. Each box
creates a rectangular area in the resulting page and it corresponds to a particular
rendered HTML element. There may be multiple boxes corresponding to a single element;
e.g. a multi-line paragraph <d:tag>p</d:tag> is split to several line boxes. A box may be
either composed from child boxes or it may correspond to a particular part of the
document content, which may be a text string or replaced content (e.g. images).</p>
<p>Each box is represented by an object which extends the
<d:api class="org/fit/cssbox/layout/Box">Box</d:api> abstract class. There exist
several box types that roughly correspond to the computed value of the CSS <code>display</code>
property for the corresponding element. Figure 1 shows the type hierarchy of boxes.</p>

<d:fig index="1" title="Box type hierarchy" src="box_classes.png" />

<p>The root node of the box tree is always represented by a
<d:api class="org/fit/cssbox/layout/Viewport">Viewport</d:api> object and it represents
the browser viewport. It has always a single child which is called a <dfn>root box</dfn>.
The root box corresponds to the root element of the HTML code passed to the
<d:api class="org/fit/cssbox/layout/BrowserCanvas">BrowserCanvas</d:api> for rendering.
Usually, it is the <d:tag>body</d:tag> element.</p>

<p>The viewport and the root box are obtained using the
<d:api class="org/fit/cssbox/layout/BrowserCanvas" anchor="getViewport()">getViewport()</d:api> and
<d:api class="org/fit/cssbox/layout/BrowserCanvas" anchor="getRootBox()">getRootBox()</d:api> methods
of the BrowserCanvas.</p>

<p>In the following chapters, we will mention the most important methods that
can be used for obtaining information about the resulting document layout. For
other methods, see the <d:api>CSSBox API reference</d:api>.</p>

<d:subsection id="modelBox">
<d:title>Basic Box Properties</d:title>
<p>The basic box properties are defined in the <d:api class="org/fit/cssbox/layout/Box">Box</d:api>
abstract class. They are mostly related to the box position and size.</p>

	<d:subsubsection id="boxPositions">
	<d:title>Box Position and Size</d:title>
	<p>During the layout, the box position is first computed relatively to the containing box and
	in the next step, the absolute position in the page is computed. The box occupies a rectangular
	area in the page which includes the box contents, borders and margins. The contents of the box
	is always inside of this area and it is again a rectangle which is equal or smaller than the whole box.
	Following methods can be used for obtaining the positions and sizes:</p>
	<dl>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getAbsoluteBounds()">getAbsoluteBounds()</d:api></dt>
		<dd>Returns the absolute box position and size on the page including all the borders
		and margins. The result is the <code>java.awt.Rectangle</code> object.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getBounds()">getBounds()</d:api></dt>
		<dd>Returns the box position and size relatively to the top-left corner of the containing block.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getAbsoluteContentX()">getAbsoluteContentX()</d:api></dt>
		<dd>The absolute X coordinate of the top left corner of the box contents.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getAbsoluteContentY()">getAbsoluteContentY()</d:api></dt>
		<dd>The absolute Y coordinate of the top left corner of the box contents.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getContentX()">getContentX()</d:api></dt>
		<dd>The absolute X coordinate of the top left corner of the box contents relatively to the containing block.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getContentY()">getContentY()</d:api></dt>
		<dd>The absolute Y coordinate of the top left corner of the box contents relatively to the containing block.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getContentWidth()">getContentWidth()</d:api></dt>
		<dd>The width of the box content without any margins and borders.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getContentHeight()">getContentHeight()</d:api></dt>
		<dd>The height of the box content without any margins and borders.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor=""></d:api></dt>
		<dd></dd>
	</dl>
	</d:subsubsection>
	
	<d:subsubsection id="boxStructure">
	<d:title>Box Tree Structure</d:title>
	<dl>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getParent()">getParent()</d:api></dt>
		<dd>Returns the parent box of this box or <code>null</code> if this is the root box.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getContainingBlock()">getContainingBlock()</d:api></dt>
		<dd>Returns the containing block for this box.</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getViewport()">getViewport()</d:api></dt>
		<dd>The corresponding <d:api class="org/fit/cssbox/layout/Viewport">Viewport</d:api>
		object (the root of the box tree).</dd>
		<dt><d:api class="org/fit/cssbox/layout/Box" anchor="getNode()">getNode()</d:api></dt>
		<dd>The DOM node this box corresponds to. There may be multiple boxes
		corresponding to a single DOM node.</dd>
	</dl>
	</d:subsubsection>

</d:subsection>

<d:subsection id="modelText">
<d:title>Text Boxes</d:title>
<p>A text box always box corresponds to a DOM node of the type <code>Text</code>. It is represented
as <d:api class="org/fit/cssbox/layout/TextBox">TextBox</d:api> object. When the text is split to
several lines, multiple boxes correspond to a single DOM node. In this case each of them contains
a corresponding substring of the text.</p>

	<d:subsubsection id="textText">
	<d:title>Obtaining the Text Content</d:title>
	<dl>
		<dt><d:api class="org/fit/cssbox/layout/TextBox" anchor="getText()">getText()</d:api></dt>
		<dd>Returns the text string corresponding to this node.</dd>
	</dl>
	</d:subsubsection>
	
</d:subsection>

<d:subsection id="modelElement">
<d:title>Element Boxes</d:title>
<p>An element box corresponds to a DOM node of the type <code>Element</code>. It is represented
as an object of the abstract <d:api class="org/fit/cssbox/layout/ElementBox">ElementBox</d:api>
class. It can be implemented as an inline box or a block box as described below. The common
methods of the element boxes are the following:</p>

	<d:subsubsection id="elementStructure">
	<d:title>Box Tree Structure</d:title>
	<p>Each element box may contain any number of nested child boxes that are indexed 
	from <em>0</em> to <em>n</em>. When there exist multiple element
	boxes that correspond to a single DOM node, all these boxes share all the child boxes. 
	The child boxes that belong to a particular element box can be determined using
	their index - the <d:api class="org/fit/cssbox/layout/ElementBox" anchor="getStartChild()">getStartChild()</d:api>
	and the <d:api class="org/fit/cssbox/layout/ElementBox" anchor="getEndChild()">getEndChild()</d:api>
	methods give the first and the last index of the child boxes that belong to this particular element box.
	Therefore, the normal way of processing all the child boxes of an element box <code>b</code> is following: </p>
	
<d:codebox>
for (int i = b.getStartChild(); i &lt; b.getEndChild(); i++)
{
    Box sub = b.getSubBox(i);
    <em>//process the child box here...</em>
}
</d:codebox>
	
	<p>The overview of the related ElementBox methods follows:</p>
	<dl>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getStartChild()">getStartChild()</d:api></dt>
		<dd>Returns the index of the first child box contained in this element box.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getEndChild()">getEndChild()</d:api></dt>
		<dd>Returns the index of the first child box <strong>not</strong> contained in this element box.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getSubBox(int)">getSubBox(int)</d:api></dt>
		<dd>Returns the child box with the given index.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getSubBoxNumber()">getSubBoxNumber()</d:api></dt>
		<dd>The number of child boxes in this box.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getElement()">getElement()</d:api></dt>
		<dd>The corresponding DOM Element.</dd>
	</dl>
	</d:subsubsection>
	
	<d:subsubsection id="elementModel">
	<d:title>Box Sizes</d:title>
	<p>The dimensions of an element box are modelled according to the
	<a href="http://www.w3.org/TR/CSS21/box.html">CSS Box Model</a>. In addition
	to the <em>content size</em> discussed in the <d:ref target="boxPositions"><code>Box
	interface description</code></d:ref>, it consists of <em>padding</em>, 
	<em>border width</em> and <em>margin</em>. All these dimensions are represented
	by objects of a special <d:api class="org/fit/cssbox/layout/LengthSet">LengthSet</d:api>
	class that contain the <code>top</code>, <code>left</code>, <code>bottom</code> and
	<code>right</code> values of the dimension.</p>
	<p>There are two values of <em>margin</em> available: A computed value of the margin
	that corresponds to the specified style and an efficient margin value (<em>emargin</em>)
	that considers the margin collapsing and it is used during the layout.</p>
	<p>Following methods can be used for obtaining the individual values:</p>
	<dl>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getPadding()">getPadding()</d:api></dt>
		<dd>Returns the padding sizes.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getBorder()">getBorder()</d:api></dt>
		<dd>The border sizes.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getMargin()">getMargin()</d:api></dt>
		<dd>The computed margin sizes.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getEMargin()">getEMargin()</d:api></dt>
		<dd>The efficient margin sizes used during the layout with margin collapsing.</dd>
	</dl>
	</d:subsubsection>
	
	<d:subsubsection id="elementVisual">
	<d:title>Visual Properties of the Element Box</d:title>
	<dl>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getDisplay()">getDisplay()</d:api></dt>
		<dd>Represents the value of the <code>display:</code> CSS property. The returned
		value is one of the following constants defined in the
		<d:api class="org/fit/cssbox/layout/ElementBox">ElementBox</d:api> class:
			<code>DISPLAY_ANY</code>,
			<code>DISPLAY_BLOCK</code>,
			<code>DISPLAY_INLINE</code>,
			<code>DISPLAY_INLINE_BLOCK</code>,
			<code>DISPLAY_INLINE_TABLE</code>,
			<code>DISPLAY_LIST_ITEM</code>,
			<code>DISPLAY_NONE</code>,
			<code>DISPLAY_RUN_IN</code>,
			<code>DISPLAY_TABLE</code>,
			<code>DISPLAY_TABLE_CAPTION</code>,
			<code>DISPLAY_TABLE_CELL</code>,
			<code>DISPLAY_TABLE_COLUMN</code>,
			<code>DISPLAY_TABLE_COLUMN_GROUP</code>,
			<code>DISPLAY_TABLE_FOOTER_GROUP</code>,
			<code>DISPLAY_TABLE_HEADER_GROUP</code>,
			<code>DISPLAY_TABLE_ROW</code>,
			<code>DISPLAY_TABLE_ROW_GROUP</code>.
		</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor="getBgcolor()">getBgcolor()</d:api></dt>
		<dd>The background color of the element or null when transparent.</dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor=""></d:api></dt>
		<dd></dd>
		<dt><d:api class="org/fit/cssbox/layout/ElementBox" anchor=""></d:api></dt>
		<dd></dd>
	</dl>
	</d:subsubsection>
	
</d:subsection>

<d:subsection id="modelInline">
<d:title>Inline Boxes</d:title>
<p>Inline boxes are the <d:ref target="modelElement">element boxes</d:ref> with value
of the CSS <code>display:</code> property equal to <code>inline</code>. These boxes are
represented as the <d:api class="org/fit/cssbox/layout/InlineBox">InlineBox</d:api> objects.
They have no special properties in addition to the properties defined in the
<d:api class="org/fit/cssbox/layout/ElementBox">ElementBox</d:api> class.</p>
</d:subsection>

<d:subsection id="modelBlock">
<d:title>Block Boxes</d:title>
<p>Block boxes, with the <code>display:</code> value set to <code>block</code>
are represented by the 
<d:api class="org/fit/cssbox/layout/BlockBox">BlockBox</d:api> objects. 
In addition, the boxes with other values of the <code>display:</code> property
are represented by several special classes derived from this class:</p>
<ul>
	<li><d:api class="org/fit/cssbox/layout/ListItemBox">ListItemBox</d:api></li>
	<li><d:api class="org/fit/cssbox/layout/TableBox">TableBox</d:api></li>
	<li><d:api class="org/fit/cssbox/layout/TableCaptionBox">TableCaptionBox</d:api></li>
	<li><d:api class="org/fit/cssbox/layout/TableBodyBox">TableBodyBox</d:api></li>
	<li><d:api class="org/fit/cssbox/layout/TableRowBox">TableRowBox</d:api></li>
	<li><d:api class="org/fit/cssbox/layout/Viewport">Viewport</d:api></li>
</ul> 
<p>These objects differ mainly in the way how the boxes and their contents are laid out
on the page. From the resulting layout model point of view, they have no special
properties in addition to the properties defined in the
<d:api class="org/fit/cssbox/layout/ElementBox">ElementBox</d:api> class.</p>
</d:subsection>

<d:subsection id="modelColors">
<d:title>Fonts and Colors</d:title>
<p>For each box, a <d:api class="org/fit/cssbox/layout/VisualContext">VisualContext</d:api>
object is defined that gathers the information about the current text font and color. This 
object is obtained using the
<d:api class="org/fit/cssbox/layout/Box" anchor="getVisualContext()">getVisualContext()</d:api>
method of the box. Following methods can be used for obtaining the appropriate information:</p>
<dl>
	<dt><d:api class="org/fit/cssbox/layout/VisualContext" anchor="getColor()">getColor()</d:api></dt>
	<dd>Current text color.</dd>
	<dt><d:api class="org/fit/cssbox/layout/VisualContext" anchor="getFont()">getFont()</d:api></dt>
	<dd>Returns the current font represented as the <code>java.awt.Font</code> object.
	    From this object most of the font properties can be obtained.</dd>
	<dt><d:api class="org/fit/cssbox/layout/VisualContext" anchor="getFontVariant()">getFontVariant()</d:api></dt>
	<dd>Current font variant in the CSS syntax - i.e. <code>normal</code> or <code>small-caps</code>.</dd>
	<dt><d:api class="org/fit/cssbox/layout/VisualContext" anchor="getTextDecoration()">getTextDecoration()</d:api></dt>
	<dd>Current text decoration in the CSS syntax - i.e. <code>none</code>, <code>underline</code>, 
	    <code>overline</code>, <code>line-through</code> or <code>blink</code>.</dd>
</dl>
<p>The background color is only applicable to <d:ref target="modelElement">element boxes</d:ref>
as mentioned in <d:ref target="elementVisual">Visual Properties of the Element Box</d:ref>.</p>

</d:subsection>

</d:section>

<d:section id="feedback">
<d:title>Feedback</d:title>
<p>The CSSBox library and this manual are under development. Any feedback is welcome
mainly via the forums and the bug tracker available via the
<a href="http://www.sourceforge.net/projects/cssbox">project page</a>. We will be very
happy if you want to contribute to the code. In this case, please contact the author. 
</p>
</d:section>

</d:document>